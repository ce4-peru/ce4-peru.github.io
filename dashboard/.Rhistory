library(flexdashboard)
library(rio)
library(tidyverse)
library(XML)
library(httr)
library(RCurl)
library(sf)
library(lubridate)
library(leaflet)
library(colorspace)
library(DT)
library(zoo)
library(slider)
library(plotly)
library(waffle)
library(extrafont)
library(plyr)
library(extrafont)
library(waffle)
options(scipen=999)
nac <- rio::import("https://github.com/jincio/COVID_19_PERU/blob/master/docs/reportes_minsa.xlsx?raw=true")
deps <- rio::import("https://github.com/jincio/COVID_19_PERU/blob/master/docs/reportes_minsa.xlsx?raw=true", sheet = 2)
pop <- read_csv("data/peru_pop_stratum.csv") %>%
group_by(dep_adm1) %>%
dplyr::summarise(pop = sum(N)) %>%
dplyr::mutate(REGION = toupper(dep_adm1))
c.date <- max(deps$Fecha)
y.date <- as.Date(c.date) - 1
dep <-
deps %>%
dplyr::select(dat = Fecha,
dep = REGION,
pos = Positivos_totales,
pos.imp = PositivosImputados_totales,
pas =Fallecidos,
smp =Total_muestras) %>%
dplyr::mutate(pas = pas %>% if_else(is.na(.), 0, .)) %>%
group_by(dep) %>%
dplyr::mutate(pos.lag = lag(pos, n = 1),
pos.imp.lag = lag(pos.imp, n = 1),
pas.lag = lag(pas, n = 1),
smp.lag = lag(smp, n = 1)) %>%
dplyr::filter(dat == c.date) %>%
dplyr::mutate(pos.new = abs(pos - pos.lag),
pos.imp.new = abs(pos.imp - pos.imp.lag),
pas.new = abs(pas - pas.lag),
smp.new = abs(smp - smp.lag),
ratio.new = signif(pos.new/smp.new), digits = 3)
y.dep <-
deps %>%
dplyr::select(dat = Fecha,
dep = REGION,
pos = Positivos_totales,
pos.imp = PositivosImputados_totales,
pas =Fallecidos,
smp =Total_muestras) %>%
dplyr::mutate(pas = pas %>% if_else(is.na(.), 0, .)) %>%
group_by(dep) %>%
dplyr::mutate(pos.lag = lag(pos, n = 1),
pos.imp.lag = lag(pos.imp, n = 1),
pas.lag = lag(pas, n = 1),
smp.lag = lag(smp, n = 1)) %>%
dplyr::filter(dat == y.date) %>%
dplyr::mutate(pos.new = abs(pos - pos.lag),
pos.imp.new = abs(pos.imp - pos.imp.lag),
pas.new = abs(pas - pas.lag),
smp.new = abs(smp - smp.lag),
ratio.new = signif(pos.new/smp.new), digits = 3)
## Regions geometry
shp <- st_read("Limite_departamental", stringsAsFactors = F)
shp <- shp %>%
st_transform(4326) %>%
select(Departamento = NOMBDEP)
# Append
dep <- merge(dep, shp, by.y = 'Departamento', by.x = 'dep', all.x = T)
dep <- st_as_sf(dep, sf_column_name = 'geometry')
dep <- merge(dep, pop %>% select(dep = REGION, pop))
dep <- dep %>% mutate(pos.hab = pos/pop*100000,
smp.hab = smp/pop*100000)
View(dep)
dep <-
deps %>%
dplyr::select(dat = Fecha,
dep = REGION,
pos = Positivos_totales,
pos.imp = PositivosImputados_totales,
pas =Fallecidos,
smp =Total_muestras) %>%
dplyr::mutate(pas = pas %>% if_else(is.na(.), 0, .)) %>%
group_by(dep) %>%
dplyr::mutate(pos.lag = lag(pos, n = 1),
pos.imp.lag = lag(pos.imp, n = 1),
pas.lag = lag(pas, n = 1),
smp.lag = lag(smp, n = 1)) %>%
dplyr::filter(dat == c.date) %>%
dplyr::mutate(pos.new = abs(pos - pos.lag),
pos.imp.new = abs(pos.imp - pos.imp.lag),
pas.new = abs(pas - pas.lag),
smp.new = abs(smp - smp.lag),
ratio.new = signif(pos.new/smp.new), digits = 3) %>%
mutate(if_else(is.na(pos.new)), pos.new = NA, pos.new = pos.new)
View(dep)
dep <-
deps %>%
dplyr::select(dat = Fecha,
dep = REGION,
pos = Positivos_totales,
pos.imp = PositivosImputados_totales,
pas =Fallecidos,
smp =Total_muestras) %>%
dplyr::mutate(pas = pas %>% if_else(is.na(.), 0, .)) %>%
group_by(dep) %>%
dplyr::mutate(pos.lag = lag(pos, n = 1),
pos.imp.lag = lag(pos.imp, n = 1),
pas.lag = lag(pas, n = 1),
smp.lag = lag(smp, n = 1)) %>%
dplyr::filter(dat == c.date) %>%
dplyr::mutate(pos.new = abs(pos - pos.lag),
pos.imp.new = abs(pos.imp - pos.imp.lag),
pas.new = abs(pas - pas.lag),
smp.new = abs(smp - smp.lag),
ratio.new = signif(pos.new/smp.new), digits = 3)
dep[is.na(dep$pos.new), ]$pos.new <- NA
dep[dep$pos.new == 0, ]$pos.new <- NA
View(dep)
